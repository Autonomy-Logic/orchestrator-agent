# Security and Identity

## Mutual TLS Authentication

The agent uses mutual TLS (mTLS) to authenticate both the client and server:

- **Client Authentication**: Agent loads `~/.mtls/client.crt` and `~/.mtls/client.key`
- **Server Authentication**: Verifies server certificate with `CERT_REQUIRED` and hostname checking
- **TLS Version**: Minimum TLSv1.2
- **Certificate Type**: RSA-4096 self-signed certificates

**Implementation:** `src/tools/ssl.py`

## Agent Identity

The agent's unique identifier is extracted from the client certificate's Common Name (CN) field:

```python
# Certificate subject: /C=BR/ST=SP/L=SaoPaulo/O=AutonomyLogic/OU=Development/CN=07048933
# Agent ID: 07048933
```

The agent ID is:
- Generated by the cloud provisioning API during installation
- Embedded in the certificate CN field
- Extracted once at module load time and cached
- Used to identify the device in all cloud communications

**Implementation:** `src/tools/ssl.py` - `get_agent_id()`

## Certificate Security

The installer sets strict permissions on credentials:
- Private key: `~/.mtls/client.key` (permissions: 600)
- Certificate: `~/.mtls/client.crt` (permissions: 644)
- Directory: `~/.mtls/` (permissions: 700)

## Certificate Provisioning

During installation, the agent:
1. Requests a unique orchestrator ID from the Autonomy Edge provisioning API
2. Generates an RSA-4096 key pair and certificate signing request
3. Self-signs the certificate with the orchestrator ID in the CN field
4. Uploads the certificate to the cloud for registration
5. Stores the private key and certificate in `~/.mtls/`

The cloud server maintains a registry of valid certificates and only accepts connections from registered agents.

## Security Best Practices

- **Never share** your private key (`~/.mtls/client.key`)
- **Never commit** mTLS certificates to version control
- **Rotate certificates** periodically (recommended: annually)
- **Monitor logs** for authentication failures
- **Restrict access** to the `~/.mtls/` directory

## Troubleshooting

For certificate-related issues, see [Troubleshooting - mTLS Certificate Issues](troubleshooting.md#mtls-certificate-issues).
